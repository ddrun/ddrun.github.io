---
layout:     post
title:      Redis相关-Interview
subtitle:    "\"Redis，你这个磨人的小妖精。。。\""
date:       2019-03-20
author:     d.djran@gmail.com
categories:
    - Interview
tags:
    - redis
---

## 前言
    
    缓存，谁用谁知道。。。
    本文主要介绍redis基础及部分机制的原理，包括数据结构、持久化、淘汰机制、数据删除、
    数据一致性、缓存击穿和雪崩、redis-cluster模式、哨兵模式等。
    
## 正文

###  redis数据结构
    redis数据结构有哪些？大概都适应什么样一个场景？
    =======================================================================>>>>>>>>>>>
    常用的数据结构有如下5种：
     1、string:字符串，应用于普通的k-v存储；
     2、list:可重复的有序集合，应用场景较多。如：各种列表；
     3、set:不可重复的无序集合，且提供了求交集、并集、差集等方法，应用场景多样。
        如：关注列表、粉丝列表、共同关注、共同喜好等。
     4、sorted set:不可重复的有序集合，在set的基础上加入了分值score。每个成员key在插入
        时都具有一个score值，根据score值进行自动排序。
        应用场景如消息权重（普通消息、重要消息）
     5、hash:哈希，存储hashmap、对象等类型数据。应用场景如：用户信息、会话信息、
        常见k-v结构数据等。
    
###  redis持久化
    redis持久化有哪些方式？有什么区别？你们采用的是哪种方式？
    =======================================================================>>>>>>>>>>>
    redis持久化，即将数据保存到硬盘。redis的持久化操作有两种，一种RDB（快照）,另一种
    是AOF（追加到文件）。
    （1）RDB是条件触发模式，如果条件不满足则不会触发持久化操作，容易丢失数据。AOF是将
        数据保存在file文件的末尾，不会丢失数据。
    （2）RDB是默认持久化模式，可手动关闭。AOF默认关闭，可手动开启。两种方式可同时存在，
        但redis重启后会优先从AOF中重建数据。
       
        关闭RDB方式如下：
            save ""
            #save 900 1
            #save 300 10
            #save 60 10000
        
        开启AOF方式如下:
            appendonly yes
        
    我们项目中采用的是RDB+AOF方式，先考虑将RDB方式去除。。。
    
###  redis淘汰机制
    redis的淘汰机制是什么样的？
    =======================================================================>>>>>>>>>>>
    使用redis过程中，当redis内存暂用量超过设定大小maxmemory，则会根据策略（淘汰机制）
    去删除符合条件的键值。在redis的配置文件redis.conf中配置maxmemory-policy即可，
    具体策略如下：
    （1）no-eviction:不淘汰
        redis默认的淘汰策略，不淘汰数据，即内存使用超过阈值时，所有引起申请内存的命令
        （如写操作）都会报错。
    （2）allkeys-lru:最近最少使用all-keys-Least Recently Used
        在主键空间中，移除最近最少使用的key。
    （3）allkeys-random:随机删除
        在主键空间中，随机移除key。
    （4）volatile-lru
        在设置了过期时间的键空间中，移除最近最少使用的key。
    （5）volatile-random
        在设置了过期时间的键空间中，随机移除key。
    （6）volatile-ttl:生存时间volatile-Time to Live
         在设置了过期时间的键空间中，移除更早过期的key。
             
    PS：
    （1）主键空间和设置过期时间的键空间
        所有的redis中的键值都会存储于一个hash表中，当这些键值中有一部分设置了过期时间，
        在设置了过期时间的键值还存储到另一个hash表中，则设置过期时间的键空间可以看做
        是主键空间的子集。       
    （2）从上述策略中，redis提供的淘汰策略大概分为三种，一是noeviction，不进行淘汰，
        直接报错；二是allkeys在主键空间淘汰数据；三是volatile，在设置了过期时间的
        键空间中淘汰key。
    
###  redis数据删除
    redis数据过期后，会立即删除吗？按照什么方式删除？
    =======================================================================>>>>>>>>>>>
    redis数据在设置了过期时间后，会基于redis过期键删除策略进行数据删除。删除策略有以下
    几种：
    （1）立即删除
        key过期后立即将其删除，及时释放内存，但对cpu资源使用不友好；
    （2）定时删除
        key过期后不会立即清除，redis会定时检查，主动的将过期key进行删除；
        
        PS:
        定时删除策略原理简述
            基于redis的时间事件来实现，redis.c/serverCron即为redis的定时任务，redis3.0
        默认执行频率为10次/s，可通过修改redis.conf中的hz选型来调整执行频率（如下图所示）。
        该定时任务处理的工作其实有很多，删除过期key只是其众多工作中的一项。
            key清理在redis.c/activeExpireCyle函数中实现。过期key定时删除即基于redis定时
        任务serverCorn,定时调用清理函数activeExpireCyle，将过期key进行删除。
        
            # Not all tasks are perforemd with the same frequency, but Redis checks for
            # tasks to perform according to the specified "hz" value.
            #
            # By default "hz" is set to 10. Raising the value will use more CPU when
            # Redis is idle, but at the same time will make Redis more responsive when
            # there are many keys expiring at the same time, and timeouts may be
            # handled with more precision.
            #
            # The range is between 1 and 500, however a value over 100 is usually not
            # a good idea. Most users should use the default of 10 and raise this up to
            # 100 only in environments where very low latency is required.
            hz 10
   
    （3）惰性删除（被动删除）
        key过期后不会立即删除，当下次操作该过期key时会触发惰性删除将其删除；此策略对内存
        资源不友好；
        
    redis使用的过期key删除策略是惰性删除加个定时删除，两者配合使用。
    
###  redis集群处理
    redis有做集群处理吗？采用的什么集群方式？
    =======================================================================>>>>>>>>>>>
    redis集群实现的技术基础是分片或者分区，即将数据分割到不通redis实例中，每个redis实例
    只保留全部数据的一个子集。我的理解中大概可分为三种模式：客户端分片、服务端分片、基于
    代理的分片。
        1 客户端分片：如jedis客户端等
    由客户端决定数据的写入或读取的节点；需要客户端来实现分片、路由、扩容等处理。
        2 服务端分片：如redis-cluster官方方案
    由服务端决定数据写入或读取的节点；服务端和客户端都需要相应的处理，服务端官方方案教程
    较详细，非常容易搭建，客户端改造在大部分的框架sdk中也基本都有相应的集成。
        3 基于代理的分片：如codis\twemproxy等
    由中间件proxy决定数据写入或读取的节点，服务端和客户端都相对独立，集群分片等处理由
    中间件完成。
        
        我们采用的是redis-cluster方案，搭建redis集群过程、redis-cluster原理后续会有文章
     进行详细介绍。
   
   <a href="https://ddrun.github.io/2019/03/20/about-Redis/" target="_blank">搭建redis-cluster集群</a>
   <a href="https://ddrun.github.io/2019/03/20/about-Redis/" target="_blank">redis-cluster原理机制</a>
    
###  redis数据一致性
    项目中redis数据一致性问题有碰到过吗？做了哪些处理？
    =======================================================================>>>>>>>>>>>
    项目中经常为了减少DB压力或提高查询效率，会将某些数据放到redis中，读取的时候优先
    从redis中获取，但是因为数据库和redis无法做到强一致性，所以肯定会碰到数据不一致的问题。
    
    数据不一致的原因有很多，如数据库事务回滚，redis数据已变更却无法回滚；redis未及时同步
    数据库数据的变更等都会导致数据的不一致；一般的做法是保存数据到DB，同步数据到redis，
    且在读、写、同步等处理上都有相应策略。
        读：先查redis，数据miss则查询db，并将数据同步到redis。
        写：写DB，不写redis。
        更新：更新DB,失效现有redis数据，再异步同步数据到redis。
    上述写数据的时候一般不会立即同步到redis，避免事务回滚和高并发写入数据产生的脏数据。
   
        数据库和redis之间没有绝对的强一致性，只有数据的最终一致性。
        在我们的项目中也存在数据一致性问题，我们在按照上述处理规范下，有专门的服务来
     维护DB与redis的数据一致性。
    
###  缓存击穿-缓存雪崩
    缓存击穿和缓存雪崩碰到过吗？如何处理？
    =======================================================================>>>>>>>>>>>
        缓存击穿（缓存穿透）：恶意请求一个不存在key，大量请求就会转到DB数据库上，导致数
    据库连接池满，连接异常等现象。
        解决方案：
            （1）服务限流，安全控制，设置有效拦截机制；
            （2）采用布隆过滤器，访问不存在key的请求直接被过滤；
        
        缓存雪崩：缓存数据库重启或缓存大面积失效，大量请求就会转到DB数据库上，导致数据库
        连接异常等现象。
        解决方案：
            （1）调整缓存失效机制，比如对相同类数据设置不同的失效时间，在原有失效基础添加
            随机值时间；
            （2）某些数据不设置过期时间，基于具体业务设定，需慎用。
            
         如何处理问题永远都需要根据具体实际情况来分析，没有最好。。。
    
###  项目中的redis
    你们项目中redis存哪些数据？
    =======================================================================>>>>>>>>>>>
    项目中引入redis的初衷是为了提高效率，引入之后，哪些数据放在redis、采用哪种结构、
    什么时候过期、会 产生什么问题等都是需要考虑的问题。
    我们在redis中存放了如下几种数据：
        （1）身份令牌access_token，包含用户信息；
        （2）热数据：热点、头条文章，首页服务等；
        （3）配置数据：路由信息、字典数据等；
        （4）临时业务数据：业务临时使用数据。
    
###  redis原理机制
    对redis内部机制了解吗？比如redis-cluster、哨兵、定时任务、事件等的原理了解吗？ 
    =======================================================================>>>>>>>>>>>
       
## 后记
    
   **路漫漫其修远兮 吾将上下而求索**
   
  <d.djran@gmail.com> 


